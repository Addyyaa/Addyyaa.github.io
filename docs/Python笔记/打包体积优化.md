# python打包体积优化

## 方案一

使用虚拟环境，使用干净的环境，仅安装所需库的依赖文件使用`pyinstaller`打包，并使用`upx`工具压缩`exe`

```powershell
python -m venv venv
./venv/Script/activate
pyninstaller --onefile xxx.py
upx --best --lzma xxx.exe
```



## 方案二

使用`nuitka`工具`pip install nuitka` 前提电脑需要安装`visual studio 2022`

```cmd
python -m nuitka version_publisher.py ^
  --onefile ^
  --standalone ^
  --msvc=latest ^
  --lto=yes ^
  --remove-output ^
  --enable-plugin=upx ^
  --include-package-data=asserts
```



## 方案三

手动排除不需要用到的库，使用`--exclude`参数排除

# 解决打包成exe文件后，无法找到资源文件

现在资源目录下创建`__init__.py`

```python
def package_resource(resource_path: str, file_name: str):
    """
    静态方法，将资源包变成包资源
    """
    # 1) 优先：作为包资源（Nuitka/PyInstaller/源码都可）
    try:
        from importlib.resources import files, as_file

        res = files(resource_path).joinpath(file_name)
        with as_file(res) as p:
            if p.is_file():
                return p
    except Exception as e:
        logger.error(f"将资源包变成包资源失败: {e}")

    # 2) 其次：exe 目录 / _MEIPASS（PyInstaller）/ 模块目录 / CWD
    exe_dir = Path(sys.argv[0]).resolve().parent  # exe 所在目录（Nuitka/普通运行均可）
    meipass = Path(getattr(sys, "_MEIPASS", exe_dir))  # PyInstaller 兼容
    module_dir = Path(__file__).resolve().parent
    cwd = Path.cwd()

    candidates = [
        # 打包运行（PyInstaller 可能会命中）
        meipass / resource_path / file_name,
        meipass / file_name,
        # 外置文件：exe 同目录（最常用）
        exe_dir / file_name,
        # 源码/临时解包目录
        module_dir / resource_path / file_name,
        module_dir / file_name,
        # 外置文件：当前工作目录
        cwd / file_name,
        cwd / resource_path / file_name,
    ]
    for p in candidates:
        if p.is_file():
            return p
    raise FileNotFoundError(
        "未找到 user.env，请确认它位于 asserts 目录（与 exe 同目录或已打包为资源）"
    )
```

